<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RM10 Cash Voucher Redemption</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.2em;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.1em;
        }
        
        .voucher-value {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
            font-size: 0.95em;
        }
        
        .voucher-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .voucher-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .voucher-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .voucher-card.redeemed {
            background: #f3f4f6;
            border-color: #d1d5db;
            opacity: 0.6;
        }
        
        .voucher-code {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .voucher-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-available {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-redeemed {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .qr-display {
            margin: 30px 0;
        }
        
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .redemption-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .print-btn {
            margin-left: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíµ RM10 Cash Voucher</h1>
        <p class="subtitle">Redemption System for 50 Vouchers</p>
        
        <div class="voucher-value">
            RM500 Total Value (50 x RM10)
        </div>
        
        <!-- Warning Banner -->
        <div id="warningBanner" style="display: none; background: #fef3c7; border: 2px solid #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; color: #92400e;">
        </div>
        
        <!-- Statistics Dashboard -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalVouchers">50</div>
                <div class="stat-label">Total Vouchers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="redeemedCount">0</div>
                <div class="stat-label">Redeemed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableCount">50</div>
                <div class="stat-label">Available</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalValue">RM0</div>
                <div class="stat-label">Total Redeemed</div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button onclick="generateAllVouchers()">üé´ Generate All 50 Vouchers</button>
            <button onclick="printAllVouchers()" class="btn-success print-btn">üñ®Ô∏è Print All QR Codes</button>
            <button onclick="downloadVoucherList()" class="btn-success">üì• Download List</button>
            <button onclick="resetSystem()" class="btn-danger">üîÑ Reset System</button>
        </div>
        
        <!-- Voucher Grid -->
        <div class="section">
            <h2>üìã Voucher Management</h2>
            <div id="voucherGrid" class="voucher-grid">
                <!-- Vouchers will be generated here -->
            </div>
        </div>
        
        <!-- Redemption Log -->
        <div class="section">
            <h2>üìä Redemption Log</h2>
            <div id="redemptionLog">
                <p style="color: #999; text-align: center;">No redemptions yet</p>
            </div>
        </div>
    </div>
    
    <!-- QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Voucher Code</h2>
            <div id="modalQR" class="qr-display"></div>
            <p id="modalCode" style="font-size: 1.5em; font-weight: bold; color: #667eea; margin: 20px 0;"></p>
            <p style="color: #666; margin-bottom: 20px;">Scan this QR code to redeem RM10</p>
            <button onclick="downloadSingleQR()" class="btn-success">Download QR</button>
            <button onclick="closeModal()" style="margin-left: 10px;">Close</button>
        </div>
    </div>
    
    <!-- Redemption Modal -->
    <div id="redeemModal" class="modal">
        <div class="modal-content">
            <h2>üéÅ Redeem Voucher</h2>
            <div id="redeemAlert"></div>
            <div class="redemption-form">
                <p style="font-size: 1.3em; font-weight: bold; color: #667eea; margin-bottom: 20px;">
                    Code: <span id="redeemCode"></span>
                </p>
                <input type="text" id="customerName" placeholder="Customer Name" required>
                <input type="text" id="customerPhone" placeholder="Phone Number" required>
                <input type="email" id="customerEmail" placeholder="Email (optional)">
                <button onclick="confirmRedemption()" class="btn-success" style="width: 100%; margin-top: 10px;">‚úì Confirm Redemption</button>
                <button onclick="closeRedeemModal()" style="width: 100%; margin-top: 10px;">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        let vouchers = [];
        let currentVoucherCode = '';
        
        // Initialize system
        function initSystem() {
            const saved = localStorage.getItem('voucherSystem');
            if (saved) {
                vouchers = JSON.parse(saved);
            } else {
                generateAllVouchers();
            }
            updateDisplay();
        }
        
        // Generate unique voucher code
        function generateCode(index) {
            const prefix = 'RM10';
            const code = String(index + 1).padStart(3, '0');
            return `${prefix}-${code}`;
        }
        
        // Generate all 50 vouchers
        function generateAllVouchers() {
            if (vouchers.length > 0) {
                if (!confirm('This will reset all vouchers. Continue?')) return;
            }
            
            vouchers = [];
            for (let i = 0; i < 50; i++) {
                vouchers.push({
                    code: generateCode(i),
                    value: 10,
                    redeemed: false,
                    redeemedBy: null,
                    redeemedAt: null,
                    customerName: null,
                    customerPhone: null,
                    customerEmail: null
                });
            }
            saveSystem();
            updateDisplay();
            alert('50 vouchers generated successfully!');
        }
        
        // Save to localStorage
        function saveSystem() {
            localStorage.setItem('voucherSystem', JSON.stringify(vouchers));
        }
        
        // Update display
        function updateDisplay() {
            const redeemed = vouchers.filter(v => v.redeemed).length;
            const available = vouchers.length - redeemed;
            const totalRedeemed = redeemed * 10;
            
            document.getElementById('totalVouchers').textContent = vouchers.length;
            document.getElementById('redeemedCount').textContent = redeemed;
            document.getElementById('availableCount').textContent = available;
            document.getElementById('totalValue').textContent = `RM${totalRedeemed}`;
            
            // Show warning banner based on redemption status
            const banner = document.getElementById('warningBanner');
            if (redeemed >= 50) {
                banner.style.display = 'block';
                banner.style.background = '#fee2e2';
                banner.style.borderColor = '#ef4444';
                banner.style.color = '#991b1b';
                banner.innerHTML = 'üö´ ALL 50 VOUCHERS FULLY REDEEMED - NO MORE REDEMPTIONS AVAILABLE';
            } else if (redeemed >= 45) {
                banner.style.display = 'block';
                banner.style.background = '#fef3c7';
                banner.style.borderColor = '#f59e0b';
                banner.style.color = '#92400e';
                banner.innerHTML = `‚ö†Ô∏è ALMOST SOLD OUT! Only ${available} vouchers remaining`;
            } else if (redeemed >= 40) {
                banner.style.display = 'block';
                banner.style.background = '#dbeafe';
                banner.style.borderColor = '#3b82f6';
                banner.style.color = '#1e40af';
                banner.innerHTML = `üì¢ Running low! ${available} vouchers still available`;
            } else {
                banner.style.display = 'none';
            }
            
            // Update voucher grid
            const grid = document.getElementById('voucherGrid');
            grid.innerHTML = vouchers.map(v => `
                <div class="voucher-card ${v.redeemed ? 'redeemed' : ''}" onclick="showVoucherQR('${v.code}')">
                    <div class="voucher-code">${v.code}</div>
                    <div>RM10</div>
                    <div class="voucher-status ${v.redeemed ? 'status-redeemed' : 'status-available'}">
                        ${v.redeemed ? '‚úì Redeemed' : '‚óã Available'}
                    </div>
                </div>
            `).join('');
            
            // Update redemption log
            updateRedemptionLog();
        }
        
        // Update redemption log
        function updateRedemptionLog() {
            const log = document.getElementById('redemptionLog');
            const redeemed = vouchers.filter(v => v.redeemed);
            
            if (redeemed.length === 0) {
                log.innerHTML = '<p style="color: #999; text-align: center;">No redemptions yet</p>';
                return;
            }
            
            log.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Customer</th>
                            <th>Phone</th>
                            <th>Date & Time</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${redeemed.map(v => `
                            <tr>
                                <td><strong>${v.code}</strong></td>
                                <td>${v.customerName || 'N/A'}</td>
                                <td>${v.customerPhone || 'N/A'}</td>
                                <td>${new Date(v.redeemedAt).toLocaleString()}</td>
                                <td><strong>RM${v.value}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Show QR code for voucher
        function showVoucherQR(code) {
            const voucher = vouchers.find(v => v.code === code);
            if (!voucher) return;
            
            currentVoucherCode = code;
            
            if (voucher.redeemed) {
                // Show redemption details
                alert(`This voucher has already been redeemed by ${voucher.customerName} on ${new Date(voucher.redeemedAt).toLocaleString()}`);
                return;
            }
            
            // Check if all 50 vouchers are redeemed
            const redeemedCount = vouchers.filter(v => v.redeemed).length;
            if (redeemedCount >= 50) {
                alert('üö´ ALL 50 VOUCHERS FULLY REDEEMED\n\nSorry, all vouchers have been claimed. No more redemptions are available.');
                return;
            }
            
            // Show QR modal
            document.getElementById('modalTitle').textContent = `Voucher ${code}`;
            document.getElementById('modalCode').textContent = code;
            document.getElementById('modalQR').innerHTML = '';
            
            const redeemUrl = `${window.location.href.split('?')[0]}?redeem=${code}`;
            new QRCode(document.getElementById('modalQR'), {
                text: redeemUrl,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            document.getElementById('qrModal').classList.add('active');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('qrModal').classList.remove('active');
        }
        
        // Download single QR
        function downloadSingleQR() {
            const canvas = document.querySelector('#modalQR canvas');
            if (canvas) {
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `voucher-${currentVoucherCode}.png`;
                link.href = url;
                link.click();
            }
        }
        
        // Print all vouchers
        function printAllVouchers() {
            const printWindow = window.open('', '', 'width=800,height=600');
            let html = `
                <html>
                <head>
                    <title>Print All Vouchers</title>
                    <style>
                        body { font-family: Arial; }
                        .voucher { 
                            page-break-inside: avoid; 
                            border: 2px solid #667eea; 
                            padding: 20px; 
                            margin: 20px; 
                            text-align: center;
                            display: inline-block;
                            width: 300px;
                        }
                        .code { font-size: 24px; font-weight: bold; color: #667eea; }
                        .value { font-size: 32px; font-weight: bold; margin: 10px 0; }
                        @media print {
                            .voucher { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <h1 style="text-align: center;">RM10 Cash Vouchers</h1>
            `;
            
            vouchers.forEach(v => {
                html += `
                    <div class="voucher">
                        <div class="code">${v.code}</div>
                        <div class="value">RM${v.value}</div>
                        <div id="qr-${v.code}"></div>
                        <p>Scan to redeem</p>
                    </div>
                `;
            });
            
            html += `
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
                    <script>
                        setTimeout(() => {
                            ${vouchers.map(v => `
                                new QRCode(document.getElementById('qr-${v.code}'), {
                                    text: '${window.location.href.split('?')[0]}?redeem=${v.code}',
                                    width: 150,
                                    height: 150
                                });
                            `).join('')}
                            setTimeout(() => window.print(), 1000);
                        }, 500);
                    <\/script>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
        }
        
        // Download voucher list
        function downloadVoucherList() {
            let csv = 'Voucher Code,Value,Status,Redeemed By,Phone,Date\n';
            vouchers.forEach(v => {
                csv += `${v.code},RM${v.value},${v.redeemed ? 'Redeemed' : 'Available'},${v.customerName || ''},${v.customerPhone || ''},${v.redeemedAt ? new Date(v.redeemedAt).toLocaleString() : ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'voucher-list.csv';
            link.href = url;
            link.click();
        }
        
        // Check for redemption URL
        function checkRedemptionUrl() {
            const params = new URLSearchParams(window.location.search);
            const redeemCode = params.get('redeem');
            
            if (redeemCode) {
                const voucher = vouchers.find(v => v.code === redeemCode);
                
                // Check if all vouchers are redeemed
                const redeemedCount = vouchers.filter(v => v.redeemed).length;
                if (redeemedCount >= 50) {
                    alert('üö´ PROMOTION ENDED\n\nAll 50 vouchers have been fully redeemed.\n\nTotal distributed: RM500\n\nThank you for your interest!');
                    // Scroll to show the banner
                    window.scrollTo(0, 0);
                    return;
                }
                
                if (voucher) {
                    if (voucher.redeemed) {
                        showRedeemAlert('This voucher has already been redeemed!', 'error');
                        setTimeout(() => {
                            alert('‚ö†Ô∏è This voucher was already claimed by another customer.\n\nPlease check with the promotion organizer.');
                        }, 500);
                    } else {
                        showRedeemModal(redeemCode);
                    }
                } else {
                    showRedeemAlert('Invalid voucher code!', 'error');
                    setTimeout(() => {
                        alert('‚ùå Invalid voucher code.\n\nPlease check the QR code and try again.');
                    }, 500);
                }
            }
        }
        
        // Show redeem modal
        function showRedeemModal(code) {
            currentVoucherCode = code;
            document.getElementById('redeemCode').textContent = code;
            document.getElementById('redeemAlert').innerHTML = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('redeemModal').classList.add('active');
        }
        
        // Close redeem modal
        function closeRedeemModal() {
            document.getElementById('redeemModal').classList.remove('active');
        }
        
        // Show alert in redeem modal
        function showRedeemAlert(message, type) {
            const alert = document.getElementById('redeemAlert');
            alert.innerHTML = `<div class="alert alert-${type === 'error' ? 'error' : 'success'}">${message}</div>`;
        }
        
        // Confirm redemption
        function confirmRedemption() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            
            if (!name || !phone) {
                showRedeemAlert('Please enter customer name and phone number', 'error');
                return;
            }
            
            const voucher = vouchers.find(v => v.code === currentVoucherCode);
            if (!voucher) {
                showRedeemAlert('Voucher not found!', 'error');
                return;
            }
            
            if (voucher.redeemed) {
                showRedeemAlert('This voucher has already been redeemed!', 'error');
                return;
            }
            
            // Check if all vouchers are already redeemed
            const redeemedCount = vouchers.filter(v => v.redeemed).length;
            if (redeemedCount >= 50) {
                showRedeemAlert('‚ùå Sorry! All 50 vouchers have been fully redeemed. No more vouchers available.', 'error');
                return;
            }
            
            // Mark as redeemed
            voucher.redeemed = true;
            voucher.redeemedBy = name;
            voucher.redeemedAt = new Date().toISOString();
            voucher.customerName = name;
            voucher.customerPhone = phone;
            voucher.customerEmail = email;
            
            saveSystem();
            updateDisplay();
            
            // Check if this was the 50th redemption
            const newRedeemedCount = vouchers.filter(v => v.redeemed).length;
            if (newRedeemedCount === 50) {
                showRedeemAlert(`‚úì Voucher redeemed successfully! ${name} can collect RM${voucher.value}\n\nüéâ CONGRATULATIONS! This was the LAST voucher (50/50). All vouchers are now fully redeemed!`, 'success');
                
                // Show alert to admin
                setTimeout(() => {
                    alert('üéâ PROMOTION COMPLETE!\n\nAll 50 vouchers have been fully redeemed!\nTotal: RM500\n\nNo more redemptions will be accepted.');
                }, 1000);
            } else {
                const remaining = 50 - newRedeemedCount;
                showRedeemAlert(`‚úì Voucher redeemed successfully! ${name} can collect RM${voucher.value}\n\nüìä ${remaining} vouchers remaining`, 'success');
            }
            
            setTimeout(() => {
                closeRedeemModal();
            }, 4000);
        }
        
        // Reset system
        function resetSystem() {
            if (confirm('Are you sure you want to reset the entire system? This will clear all redemption data!')) {
                localStorage.removeItem('voucherSystem');
                vouchers = [];
                generateAllVouchers();
            }
        }
        
        // Initialize on load
        initSystem();
        checkRedemptionUrl();
    </script>
</body>
</html>
